#!/bin/sh
# RevivaTech Pre-commit Hook - Claude Code Best Practices
# This hook runs the context loader and basic health checks before commits

echo "🤖 Claude Code Pre-commit Hook - RevivaTech"
echo "=============================================="

# Run context loader for health check
echo "📊 Running system health check..."
if ! /opt/webapps/revivatech/.claude/context-loader.sh > /dev/null 2>&1; then
    echo "⚠️  System health check returned warnings (continuing...)"
fi

# Check if RULE 1 METHODOLOGY should be reminded
if git diff --cached --name-only | grep -E "\.(js|ts|tsx|jsx)$" > /dev/null; then
    echo ""
    echo "🚨 RULE 1 METHODOLOGY REMINDER:"
    echo "================================"
    echo "Before creating new code, ensure you've followed:"
    echo "1. IDENTIFY - Discovered existing services"
    echo "2. VERIFY - Tested discovered functionality"
    echo "3. ANALYZE - Compared existing vs required"
    echo "4. DECISION - Chose integration over creation"
    echo "5. TEST - Performed end-to-end verification"
    echo "6. DOCUMENT - Created/updated completion report"
    echo ""
    echo "📋 Use 'npm run claude:identify' to discover existing services"
    echo ""
fi

# Check for hardcoded Tailscale IPs (forbidden)
if git diff --cached | grep -E "100\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}" > /dev/null; then
    echo "❌ COMMIT BLOCKED: Hardcoded Tailscale IP detected!"
    echo "🚫 RevivaTech Project Rule: No Tailscale IPs (100.x.x.x) in code"
    echo "✅ Use dynamic URL detection instead"
    exit 1
fi

# Check for forbidden ports
if git diff --cached | grep -E "(3000|3001|5000|5001|3308|5433|6380|6381)" > /dev/null; then
    echo "⚠️  WARNING: Detected potentially forbidden ports"
    echo "🔍 RevivaTech allowed ports: 3010, 3011, 5435, 6383, 8080-8099"
    echo "❓ Confirm this is intentional (continuing...)"
fi

echo "✅ Pre-commit checks completed"
echo ""
exit 0